              <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f8fafc">
    <title>Agenda T√°ctica 2026</title>
    
    <!-- ICONO -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2910/2910768.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }
        .bg-pattern { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 32px 32px; opacity: 0.3; pointer-events: none; z-index: 0; }
        
        .z-back { z-index: 0; }
        .z-content { z-index: 10; position: relative; }
        .z-nav { z-index: 40; position: relative; }
        .z-fab { z-index: 50; }
        .z-modal-overlay { z-index: 60; }
        .z-modal-card { z-index: 70; }
        .z-alert { z-index: 100; } 

        .timeline-track { position: absolute; left: 4rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, #cbd5e1 0%, #94a3b8 100%); border-radius: 99px; }
        
        .event-card { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; position: relative; background: #fff; overflow: hidden; border-left-width: 4px; border-top: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .card-future { background-color: #ffffff; opacity: 1; }
        .card-future .card-progress-fill { width: 0 !important; }
        .card-active { transform: scale(1.02); z-index: 20; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); border-right: 1px solid transparent; }
        .card-past { opacity: 0.95; background-color: #fdfdfd; }
        .card-completed { border-left-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .card-completed .card-progress-fill { background-color: #22c55e !important; opacity: 0.15 !important; width: 100% !important; }
        .card-progress-fill { position: absolute; top: 0; left: 0; bottom: 0; z-index: 0; transition: width 1s linear; }
        .skipped-text { text-decoration: line-through !important; color: #94a3b8 !important; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .copilot-bubble { background: #fff; border: 1px solid #e0e7ff; font-size: 0.75rem; color: #4f46e5; position: relative; margin-left: 4.5rem; margin-bottom: 1rem; margin-right: 1rem; padding: 0.75rem 1rem; border-radius: 1rem; border-top-left-radius: 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); animation: fadeIn 0.5s ease-out; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.5); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .goal-card { transition: all 0.3s ease; border: 1px solid #e2e8f0; }
        .goal-card.done { opacity: 0.6; background-color: #f8fafc; border-color: #f1f5f9; }
        .action-btn { cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .btn-confirm-delete { background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important; transition: all 0.2s ease; }
        .cat-select { position: relative; }
        .cat-delete-btn { position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; background: #ef4444; color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; z-index: 30; border: 2px solid white; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .checklist-item-actions { opacity: 0.6; transition: opacity 0.2s; }
        .group:hover .checklist-item-actions { opacity: 1; }
        .modal-card { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal-card.active { transform: translateY(0); }
        .alert-modal { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .medal-locked { filter: grayscale(100%); opacity: 0.4; }
        .medal-unlocked { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 20px rgba(234, 179, 8, 0.3); border-color: #facc15; background: #fefce8; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden relative bg-slate-50">

    <div class="bg-pattern z-back"></div>

    <!-- HEADER -->
    <header class="bg-white/90 backdrop-blur-md px-6 pt-safe pb-4 sticky top-0 z-nav border-b border-slate-100 shadow-sm">
        <div class="flex justify-between items-center mt-2">
            <div class="flex items-center gap-3 cursor-pointer group action-btn" onclick="window.toggleWeekMenu()">
                <div class="bg-slate-900 text-white p-3 rounded-2xl shadow-lg shadow-slate-200 group-active:scale-95 transition">
                    <i class="fas fa-layer-group text-sm"></i>
                </div>
                <div>
                    <h1 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none mb-1">MI AGENDA</h1>
                    <div class="flex items-center gap-1.5">
                        <span id="current-week-label" class="font-bold text-base text-slate-800 leading-none">Cargando...</span>
                        <i class="fas fa-chevron-down text-[10px] text-slate-300"></i>
                    </div>
                    <span id="current-week-date" class="text-[10px] text-slate-400 font-medium mt-0.5 block">--</span>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-1.5">
                <div class="flex gap-2">
                    <button onclick="window.openMedalsModal()" class="action-btn bg-white hover:bg-yellow-50 text-yellow-500 border border-yellow-200 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm transition active:scale-95 flex items-center justify-center w-10 h-8" title="Mis Logros"><i class="fas fa-medal"></i></button>
                    <button onclick="window.requestNotificationPermission()" id="btn-notify" class="action-btn bg-white hover:bg-slate-50 text-slate-400 border border-slate-200 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm transition active:scale-95 flex items-center justify-center w-10 h-8" title="Activar Alarmas"><i class="fas fa-bell-slash"></i></button>
                    <button onclick="window.generateDailyBriefing()" class="action-btn bg-white hover:bg-slate-50 text-indigo-600 border border-indigo-100 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm flex items-center gap-1.5 transition active:scale-95"><i class="fas fa-robot text-indigo-500"></i></button>
                </div>
                <div class="flex gap-2">
                     <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold">PUCP: <span id="days-pucp">--</span></span>
                     <span class="text-[9px] bg-red-50 text-red-600 px-2 py-0.5 rounded-full font-bold">BOMBA: <span id="days-fire">--</span></span>
                </div>
            </div>
        </div>
        <div class="w-full bg-slate-100 h-1 rounded-full overflow-hidden mt-5">
            <div id="day-progress" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
        </div>
    </header>

    <!-- MENU SEMANAL -->
    <div id="week-menu" class="hidden absolute top-28 left-0 w-full bg-white/95 backdrop-blur-xl z-nav shadow-2xl border-b border-slate-100 rounded-b-[2rem] transition-all max-h-[70vh] overflow-y-auto flex flex-col">
        <div class="p-5 border-b border-slate-100 flex justify-between items-center shrink-0">
            <span class="text-xs font-bold uppercase text-slate-400 tracking-wider">Navegar</span>
            <button onclick="window.jumpToCurrentWeek()" class="action-btn text-xs bg-slate-900 text-white px-4 py-2 rounded-full font-bold shadow hover:bg-slate-800 transition">Ir a Hoy</button>
        </div>
        <div class="p-4 bg-slate-50 border-b border-slate-100">
            <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Seguridad de Datos</h4>
            <div class="flex gap-2">
                <button onclick="window.downloadBackup()" class="flex-1 py-3 bg-white border border-indigo-100 text-indigo-600 text-xs font-bold rounded-xl shadow-sm hover:bg-indigo-50 transition flex items-center justify-center gap-2"><i class="fas fa-download"></i> Guardar</button>
                <button onclick="document.getElementById('restore-input').click()" class="flex-1 py-3 bg-white border border-emerald-100 text-emerald-600 text-xs font-bold rounded-xl shadow-sm hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i class="fas fa-upload"></i> Cargar</button>
                <input type="file" id="restore-input" class="hidden" onchange="window.restoreBackup(this)">
            </div>
            <p class="text-[9px] text-slate-400 mt-2 text-center">Tus datos viven en tu celular.</p>
        </div>
        <div class="p-4 grid grid-cols-1 gap-2 overflow-y-auto" id="week-list-container"></div>
    </div>

    <!-- AREA PRINCIPAL -->
    <main class="flex-1 overflow-y-auto relative z-content w-full scroll-smooth" id="main-scroll">
        <div id="ai-briefing-container" class="hidden mx-5 mt-5 mb-2 p-5 bg-white border border-indigo-50 rounded-3xl shadow-sm relative animate-fade-in-down">
            <button onclick="document.getElementById('ai-briefing-container').classList.add('hidden')" class="action-btn absolute top-4 right-4 text-slate-300 hover:text-slate-500"><i class="fas fa-times text-sm"></i></button>
            <div class="flex gap-4">
                <div class="mt-1 bg-indigo-50 w-10 h-10 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-satellite-dish text-indigo-500"></i></div>
                <div>
                    <h4 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1.5">Informe de Misi√≥n</h4>
                    <p id="ai-briefing-text" class="text-sm text-slate-600 leading-relaxed font-medium">Analizando...</p>
                </div>
            </div>
        </div>

        <div class="sticky top-0 bg-[#f8fafc]/90 backdrop-blur-md z-content px-6 pt-6 pb-2 transition-all">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h2 id="day-display-title" class="text-3xl font-black text-slate-900 tracking-tight capitalize leading-none">--</h2>
                    <p id="day-display-subtitle" class="text-sm text-slate-500 font-medium mt-1">--</p> 
                </div>
                <div class="flex flex-col items-end">
                     <div id="date-display" class="text-xs font-bold text-slate-500 bg-white px-3 py-1.5 rounded-xl shadow-sm border border-slate-100">--</div>
                </div>
            </div>
        </div>

        <div class="px-5 py-6 pb-36 relative min-h-full" id="timeline-container"></div>
    </main>

    <!-- NAVEGACI√ìN INFERIOR -->
    <nav class="glass-nav pb-safe shrink-0 z-nav fixed bottom-0 w-full shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
        <div class="flex justify-between px-6 py-3 overflow-x-auto hide-scrollbar gap-2" id="bottom-nav"></div>
    </nav>

    <!-- BOTONES FLOTANTES -->
    <div class="fixed bottom-28 right-6 flex flex-col gap-4 z-fab pointer-events-none">
        <button onclick="window.openWarehouseModal()" class="action-btn pointer-events-auto w-14 h-14 bg-white text-slate-600 rounded-full shadow-xl shadow-slate-300/30 flex items-center justify-center border border-slate-100 active:scale-90 transition transform hover:-translate-y-1"><i class="fas fa-box-archive text-lg"></i></button>
        <button onclick="window.openGoalsModal()" class="action-btn pointer-events-auto w-14 h-14 bg-white text-yellow-500 rounded-full shadow-xl shadow-yellow-500/10 flex items-center justify-center border border-yellow-50 active:scale-90 transition transform hover:-translate-y-1"><i class="fas fa-trophy text-lg"></i></button>
        <button onclick="window.openAddModal()" class="action-btn pointer-events-auto w-16 h-16 bg-slate-900 text-white rounded-[20px] shadow-2xl shadow-slate-900/30 flex items-center justify-center transition transform hover:scale-105 active:scale-95"><i class="fas fa-plus text-2xl"></i></button>
    </div>

    <!-- MODAL PRINCIPAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/30 z-modal-overlay hidden flex flex-col justify-end backdrop-blur-sm transition-opacity duration-300" onclick="if(event.target === this) window.closeModal()">
        <div class="bg-white w-full rounded-t-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh] modal-card z-modal-card" id="modal-card">
            <div class="px-8 py-6 flex justify-between items-center bg-white sticky top-0 z-20 border-b border-slate-50">
                <div>
                    <h3 class="font-bold text-2xl text-slate-900 leading-none" id="modal-title">Detalles</h3>
                    <p class="text-sm text-slate-400 font-medium mt-1" id="modal-time-range">--</p>
                </div>
                <button onclick="window.closeModal()" class="action-btn w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition"><i class="fas fa-times text-lg"></i></button>
            </div>

            <div class="p-8 overflow-y-auto bg-white pb-safe">
                <div id="view-mode-content" class="hidden space-y-8">
                    <div class="bg-indigo-50/50 p-4 rounded-3xl border border-indigo-100">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest"><i class="fas fa-toolbox mr-1"></i> Kits de Despliegue</h4>
                        </div>
                        <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="loadout-carousel"></div>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Checklist T√°ctico</h4>
                        <ul id="checklist-container" class="space-y-3"></ul>
                        <div class="flex gap-2 mt-4">
                            <input type="text" id="new-check-item" placeholder="Agregar pendiente..." class="flex-1 text-sm p-3 bg-slate-50 border-0 rounded-xl placeholder-slate-400">
                            <button onclick="window.addCheckItem()" class="action-btn w-11 h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="mission-control-container" class="pt-2"></div>
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button onclick="window.enableEditMode()" class="action-btn py-4 bg-white border border-slate-200 text-slate-600 font-bold text-xs rounded-2xl hover:bg-slate-50 transition active:scale-95">EDITAR</button>
                        <button id="btn-delete-event" onclick="window.deleteEvent(this)" class="action-btn py-4 bg-white border border-red-100 text-red-500 font-bold text-xs rounded-2xl hover:bg-red-50 transition active:scale-95">BORRAR</button>
                    </div>
                </div>
                <div id="gap-mode-content" class="hidden space-y-6">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 mb-4"><i class="fas fa-stopwatch text-2xl"></i></div>
                        <h3 class="text-2xl font-black text-slate-900 tracking-tight">Tiempo Libre</h3>
                        <p class="text-sm text-slate-500 mt-1">Tienes <span id="gap-duration" class="font-bold text-slate-900">-- min</span> disponibles.</p>
                    </div>
                    <div id="gap-suggestions-grid" class="grid grid-cols-1 gap-3"></div>
                </div>
                <form id="event-form" class="space-y-6 hidden">
                    <input type="hidden" id="event-id">
                    <input type="hidden" id="warehouse-origin-id">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block pl-1">T√≠tulo</label>
                        <input type="text" id="input-title" class="w-full text-xl font-bold text-slate-800 placeholder-slate-300 p-4 bg-slate-50 rounded-2xl border-0" required>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block pl-1">Inicio</label><input type="time" id="input-start" class="w-full p-4 bg-slate-50 rounded-2xl font-mono text-sm font-bold text-slate-700 border-0" required></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block pl-1">Fin</label><input type="time" id="input-end" class="w-full p-4 bg-slate-50 rounded-2xl font-mono text-sm font-bold text-slate-700 border-0"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-3 px-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Categor√≠a</label>
                            <button id="btn-add-cat" type="button" onclick="window.toggleNewCatUI()" class="action-btn text-[10px] font-bold text-blue-600 hover:underline transition">+ Nueva</button>
                            <div id="input-add-cat-group" class="hidden flex items-center gap-1">
                                <input type="text" id="input-new-cat-emoji" placeholder="Icono" class="w-8 text-[10px] p-1.5 border border-slate-200 rounded-lg bg-slate-50 text-center focus:bg-white outline-none" value="‚ö°">
                                <input type="text" id="input-new-cat-name" placeholder="Nombre..." class="w-20 text-[10px] p-1.5 border border-slate-200 rounded-lg bg-slate-50 focus:bg-white outline-none">
                                <button type="button" onclick="window.saveNewCategory()" class="bg-slate-900 text-white text-[10px] px-2 py-1.5 rounded-lg font-bold"><i class="fas fa-check"></i></button>
                                <button type="button" onclick="window.toggleNewCatUI()" class="text-slate-400 hover:text-slate-600 px-1"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2" id="category-grid"></div>
                        <input type="hidden" id="input-cat" value="general">
                    </div>
                    <button type="submit" class="action-btn w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl shadow-slate-900/20 hover:bg-slate-800 transition active:scale-95 flex justify-center items-center gap-2"><span>Guardar Actividad</span></button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE MEDALLAS -->
    <div id="medals-overlay" class="fixed inset-0 bg-slate-900/40 z-modal-overlay hidden flex flex-col justify-end backdrop-blur-sm transition-opacity duration-300" onclick="if(event.target === this) window.closeMedalsModal()">
        <div class="bg-white w-full rounded-t-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh] modal-card z-modal-card" id="medals-card">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                <div><h3 class="font-bold text-2xl text-slate-900 leading-none">Mis Logros</h3></div>
                <button onclick="window.closeMedalsModal()" class="action-btn w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-8 overflow-y-auto bg-white pb-safe grid grid-cols-1 gap-4" id="medals-grid"></div>
        </div>
    </div>

    <!-- MODAL DE ALERTA DE FIN DE MISI√ìN -->
    <div id="completion-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-alert hidden flex items-center justify-center p-6" onclick="window.closeCompletionModal()">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl alert-modal relative overflow-hidden" onclick="event.stopPropagation()">
            <div class="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20">
                <div class="absolute top-4 left-4 w-4 h-4 bg-yellow-400 rounded-full"></div>
                <div class="absolute bottom-10 right-10 w-6 h-6 bg-indigo-500 rounded-full"></div>
                <div class="absolute top-1/2 left-10 w-3 h-3 bg-red-400 rounded-full"></div>
            </div>
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
                <i class="fas fa-flag-checkered text-3xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-900 mb-2 leading-tight">¬°Misi√≥n Cumplida!</h2>
            <p id="completion-msg" class="text-slate-500 font-medium mb-8">Has completado tu actividad con √©xito.</p>
            <button onclick="window.closeCompletionModal()" class="action-btn w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl hover:bg-slate-800 transition transform hover:scale-[1.02] active:scale-95">CONTINUAR</button>
        </div>
    </div>

    <!-- MODAL METAS Y WAREHOUSE -->
    <div id="goals-overlay" class="fixed inset-0 bg-slate-900/40 z-modal-overlay hidden flex flex-col justify-end backdrop-blur-sm transition-opacity duration-300" onclick="if(event.target === this) window.closeGoalsModal()">
        <div class="bg-white w-full rounded-t-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-card z-modal-card" id="goals-card">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                <div><h3 class="font-bold text-2xl text-slate-900 leading-none">Metas 2026</h3></div>
                <button onclick="window.closeGoalsModal()" class="action-btn w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-8 overflow-y-auto bg-white pb-safe">
                <div class="space-y-4 mb-8" id="goals-list-container"></div>
                <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Nueva Meta</h4>
                    <div class="flex gap-2 mb-4 bg-white p-1 rounded-xl border border-slate-100">
                        <button onclick="window.toggleGoalType('simple')" id="btn-type-simple" class="action-btn flex-1 py-3 rounded-lg text-sm font-bold bg-slate-900 text-white transition shadow-sm">Logro üèÜ</button>
                        <button onclick="window.toggleGoalType('savings')" id="btn-type-savings" class="action-btn flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 hover:bg-slate-50 transition">Ahorro üí∞</button>
                    </div>
                    <input type="text" id="new-goal-title" placeholder="Ej: Licencia A1" class="w-full text-base font-medium p-3 bg-white border border-slate-200 rounded-xl mb-3">
                    <div id="savings-inputs" class="hidden grid grid-cols-2 gap-3 mb-3">
                        <input type="number" id="new-goal-target" placeholder="Meta S/." class="w-full text-sm p-3 bg-white border border-slate-200 rounded-xl">
                        <input type="number" id="new-goal-current" placeholder="Inicio S/." class="w-full text-sm p-3 bg-white border border-slate-200 rounded-xl">
                    </div>
                    <button onclick="window.addNewGoal()" class="action-btn w-full py-4 bg-yellow-400 text-yellow-900 rounded-xl font-bold shadow-lg shadow-yellow-400/20 active:scale-95 transition">Crear Meta</button>
                </div>
            </div>
        </div>
    </div>

    <div id="warehouse-overlay" class="fixed inset-0 bg-slate-900/40 z-modal-overlay hidden flex flex-col justify-end backdrop-blur-sm transition-opacity duration-300" onclick="if(event.target === this) window.closeWarehouseModal()">
        <div class="bg-white w-full rounded-t-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-card z-modal-card" id="warehouse-card">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                <div><h3 class="font-bold text-2xl text-slate-900 leading-none">Almac√©n</h3></div>
                <button onclick="window.closeWarehouseModal()" class="action-btn w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="p-8 overflow-y-auto bg-white pb-safe">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-6 pb-2" id="warehouse-tags">
                    <button onclick="window.filterWarehouse('all')" class="action-btn px-4 py-2 rounded-full bg-slate-900 text-white text-xs font-bold shrink-0 transition" id="filter-all">Todo</button>
                    <button onclick="window.filterWarehouse('ideas')" class="action-btn px-4 py-2 rounded-full bg-slate-100 text-slate-500 text-xs font-bold shrink-0 hover:bg-yellow-100 hover:text-yellow-600 transition" id="filter-ideas">Ideas</button>
                    <button onclick="window.filterWarehouse('compras')" class="action-btn px-4 py-2 rounded-full bg-slate-100 text-slate-500 text-xs font-bold shrink-0 hover:bg-green-100 hover:text-green-600 transition" id="filter-compras">Compras</button>
                    <button onclick="window.filterWarehouse('links')" class="action-btn px-4 py-2 rounded-full bg-slate-100 text-slate-500 text-xs font-bold shrink-0 hover:bg-blue-100 hover:text-blue-600 transition" id="filter-links">Links</button>
                    <button onclick="window.filterWarehouse('otros')" class="action-btn px-4 py-2 rounded-full bg-slate-100 text-slate-500 text-xs font-bold shrink-0 hover:bg-purple-100 hover:text-purple-600 transition" id="filter-otros">Otros</button>
                </div>
                <div class="flex gap-2 mb-6">
                    <div class="relative flex-1">
                        <input type="text" id="warehouse-input" placeholder="Vaciar la mente..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 pr-12 text-sm font-medium focus:bg-white transition" onkeypress="if(event.key === 'Enter') window.addToWarehouse()">
                        <div class="absolute right-3 top-1/2 -translate-y-1/2">
                            <select id="warehouse-cat-select" class="text-xs bg-transparent border-none text-slate-400 font-bold focus:outline-none text-right cursor-pointer">
                                <option value="ideas">üí°</option>
                                <option value="compras">üõí</option>
                                <option value="links">üîó</option>
                                <option value="otros">üì¶</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="window.addToWarehouse()" class="action-btn w-14 bg-slate-900 text-white rounded-2xl shadow-lg active:scale-95 transition flex items-center justify-center"><i class="fas fa-arrow-up"></i></button>
                </div>
                <div class="space-y-3 min-h-[200px]" id="warehouse-list"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN INICIAL ---
        const YEAR_START_DATE = new Date(2025, 11, 29); 
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // --- 2. FUNCIONES DE UTILIDAD (DEFINIDAS PRIMERO) ---
        window.timeToMins = function(t) { const [h,m] = t.split(':').map(Number); return h*60+m; }
        window.minsToTime = function(m) { let h=Math.floor(m/60)%24; let mn=m%60; return `${String(h).padStart(2,'0')}:${String(mn).padStart(2,'0')}`; }
        window.getNowMins = function() { const d = new Date(); return d.getHours()*60 + d.getMinutes() + (d.getSeconds()/60); }
        
        window.updateNotifyButton = function() {
            const btn = document.getElementById('btn-notify');
            if(Notification.permission === "granted") {
                btn.innerHTML = `<i class="fas fa-bell text-blue-500"></i>`; btn.classList.add('border-blue-200', 'bg-blue-50');
            } else {
                btn.innerHTML = `<i class="fas fa-bell-slash text-slate-400"></i>`; btn.classList.remove('border-blue-200', 'bg-blue-50');
            }
        }
        
        window.playAlarm = function() { if(audioCtx.state === 'suspended') audioCtx.resume(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(500, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime+0.1); g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.4); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.4); if(navigator.vibrate) navigator.vibrate([200,100,200]); }
        window.playSuccessSound = function() { if(audioCtx.state === 'suspended') audioCtx.resume(); const now = audioCtx.currentTime; [523.25, 659.25, 783.99].forEach((freq, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='triangle'; o.frequency.value=freq; g.gain.setValueAtTime(0.1, now+(i*0.1)); g.gain.exponentialRampToValueAtTime(0.001, now+(i*0.1)+0.6); o.connect(g); g.connect(audioCtx.destination); o.start(now+(i*0.1)); o.stop(now+(i*0.1)+0.6); }); if(navigator.vibrate) navigator.vibrate([100,50,100,50,200]); }
        window.showCompletionModal = function(t) { document.getElementById('completion-msg').innerText = `"${t}" completada.`; document.getElementById('completion-overlay').classList.remove('hidden'); window.playSuccessSound(); }
        window.closeCompletionModal = function() { document.getElementById('completion-overlay').classList.add('hidden'); }
        window.openWarehouseModal = function() { document.getElementById('warehouse-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('warehouse-card').classList.add('active'),10); window.renderWarehouse(); }
        window.closeWarehouseModal = function() { document.getElementById('warehouse-card').classList.remove('active'); setTimeout(()=>document.getElementById('warehouse-card').parentElement.classList.add('hidden'),300); }
        window.openGoalsModal = function() { document.getElementById('goals-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('goals-card').classList.add('active'),10); window.renderGoals(); }
        window.closeGoalsModal = function() { document.getElementById('goals-card').classList.remove('active'); setTimeout(()=>document.getElementById('goals-card').parentElement.classList.add('hidden'),300); }
        window.toggleGoalType = function(t) { newGoalType=t; document.getElementById('savings-inputs').classList.toggle('hidden', t!=='savings'); }
        window.openAddModal = function() { activeEvent=null; document.getElementById('view-mode-content').classList.add('hidden'); document.getElementById('gap-mode-content').classList.add('hidden'); document.getElementById('event-form').classList.remove('hidden'); document.getElementById('event-form').reset(); window.renderCategories(); document.getElementById('input-cat').value='general'; document.getElementById('modal-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('modal-card').classList.add('active'),10); }
        window.toggleNewCatUI = function() { const g = document.getElementById('input-add-cat-group'); const b = document.getElementById('btn-add-cat'); if(g.classList.contains('hidden')) { g.classList.remove('hidden'); b.classList.add('hidden'); } else { g.classList.add('hidden'); b.classList.remove('hidden'); } }
        window.closeModal = function() { document.getElementById('modal-card').classList.remove('active'); setTimeout(() => { document.getElementById('modal-overlay').classList.add('hidden'); activeEvent = null; }, 300); }
        
        // --- 3. DATOS Y ESTADO ---
        const defaultCats = { fisico: { label: "F√≠sico", color: "green", icon: "fa-dumbbell" }, estudio: { label: "Estudio", color: "blue", icon: "fa-book" }, bomba: { label: "Bomberos", color: "red", icon: "fa-fire-extinguisher" }, casa: { label: "Casa", color: "amber", icon: "fa-home" }, social: { label: "Social", color: "purple", icon: "fa-heart" }, traslado: { label: "Traslado", color: "slate", icon: "fa-bus" }, aseo: { label: "Aseo", color: "cyan", icon: "fa-spray-can" }, general: { label: "General", color: "slate", icon: "fa-circle" } };
        const templateWeek = {
            lunes: { title: "Carga M√°xima", items: [
                {id: "1", start:"05:00", end:"05:15", cat:"aseo", title:"Despertar", desc:"Aseo R√°pido (Cara/Dientes)", check:[]},
                {id: "2", start:"05:15", end:"06:00", cat:"fisico", title:"Running (Solo)", desc:"Resistencia", check:[]},
                {id: "3", start:"06:00", end:"06:30", cat:"aseo", title:"Ducha + Skincare", desc:"Aseo Personal Completo", check:[]},
                {id: "4", start:"06:30", end:"07:15", cat:"casa", title:"Chef: Cocina", desc:"Preparar Desayuno + Almuerzo Taper", check:[]},
                {id: "5", start:"07:15", end:"07:45", cat:"casa", title:"Desayuno", desc:"Comer tranquilo", check:[]},
                {id: "6", start:"07:45", end:"08:00", cat:"traslado", title:"Alistar Mochila", desc:"Salida", check:[]},
                {id: "7", start:"08:00", end:"10:00", cat:"estudio", title:"Estudio / Gesti√≥n", desc:"Opcional Bomberos / Tareas", check:[]},
                {id: "8", start:"10:30", end:"12:00", cat:"estudio", title:"ESTUDIO INTENSIVO PUCP", desc:"Reemplazo Piscina - Foco Total", check:[]},
                {id: "9", start:"12:30", end:"13:30", cat:"casa", title:"Almuerzo Solo", desc:"Calle", check:[]},
                {id: "10", start:"13:30", end:"17:30", cat:"estudio", title:"Biblioteca PUCP", desc:"Estudio Puro", check:[]},
                {id: "11", start:"18:00", end:"20:00", cat:"fisico", title:"Gimnasio", desc:"Fuerza", check:[]},
                {id: "12", start:"20:00", end:"21:00", cat:"casa", title:"Cena", desc:"Comida Fija", check:[]},
                {id: "13", start:"21:00", end:"22:00", cat:"casa", title:"Check Servicio", desc:"Lavar lo sucio / Ordenar", check:[]},
                {id: "14", start:"22:00", end:"22:15", cat:"casa", title:"DESCONEXI√ìN", desc:"Apagar pantallas", check:[{text:"Modo Avi√≥n", done:false}]},
                {id: "15", start:"22:15", end:"23:59", cat:"casa", title:"Dormir", desc:"Descanso", check:[]}
            ]},
            martes: { title: "Acad√©mico", items: [
                {id: "16", start:"05:00", end:"05:15", cat:"aseo", title:"Despertar", desc:"Aseo R√°pido", check:[]},
                {id: "17", start:"05:15", end:"06:00", cat:"fisico", title:"Caminata Gym", desc:"Ir al gym", check:[]},
                {id: "18", start:"06:00", end:"07:30", cat:"fisico", title:"GIMNASIO", desc:"Apertura 6AM", check:[]},
                {id: "19", start:"07:30", end:"08:00", cat:"aseo", title:"Ducha R√°pida + Skincare", desc:"Regreso", check:[]},
                {id: "20", start:"08:00", end:"08:45", cat:"casa", title:"Desayuno", desc:"Comida", check:[]},
                {id: "21", start:"09:00", end:"11:00", cat:"estudio", title:"Clase Se√±as", desc:"Virtual", check:[]},
                {id: "22", start:"11:00", end:"13:00", cat:"estudio", title:"Ingl√©s / Repaso", desc:"Casa", check:[]},
                {id: "23", start:"13:00", end:"14:00", cat:"casa", title:"Almuerzo", desc:"Comida Fija", check:[]},
                {id: "24", start:"14:30", end:"17:30", cat:"estudio", title:"Biblioteca", desc:"Letras", check:[]},
                {id: "25", start:"18:45", end:"22:00", cat:"bomba", title:"Guardia Noche", desc:"Servicio", check:[{text:"Cena llevada", done:false}]},
                {id: "26", start:"22:00", end:"22:15", cat:"casa", title:"DESCONEXI√ìN", desc:"", check:[]}
            ]},
            miercoles: { title: "Simulacro", items: [
                {id: "27", start:"05:00", end:"05:15", cat:"aseo", title:"Despertar", desc:"Aseo R√°pido", check:[]},
                {id: "28", start:"05:15", end:"06:00", cat:"fisico", title:"Running + Perro", desc:"Parque", check:[]},
                {id: "29", start:"06:00", end:"06:30", cat:"aseo", title:"Ducha", desc:"", check:[]},
                {id: "30", start:"06:30", end:"08:30", cat:"casa", title:"LIMPIEZA PROFUNDA", desc:"Lavander√≠a + Cocina", check:[]},
                {id: "31", start:"08:30", end:"09:00", cat:"casa", title:"Desayuno", desc:"", check:[]},
                {id: "32", start:"09:30", end:"12:30", cat:"estudio", title:"SIMULACRO PUCP", desc:"Condiciones Reales", check:[]},
                {id: "33", start:"12:30", end:"13:30", cat:"casa", title:"Almuerzo", desc:"Comida Fija", check:[]},
                {id: "34", start:"14:00", end:"18:00", cat:"estudio", title:"App Bomberos", desc:"Programaci√≥n", check:[]},
                {id: "35", start:"18:15", end:"20:00", cat:"fisico", title:"Gimnasio", desc:"Pesas", check:[]},
                {id: "36", start:"20:00", end:"21:00", cat:"casa", title:"Cena", desc:"", check:[]},
                {id: "37", start:"22:00", end:"22:15", cat:"casa", title:"DESCONEXI√ìN", desc:"", check:[]}
            ]},
            jueves: { title: "Voluntariado", items: [
                {id: "38", start:"05:00", end:"05:15", cat:"aseo", title:"Despertar", desc:"", check:[]},
                {id: "39", start:"05:15", end:"06:00", cat:"fisico", title:"Funcional Casa", desc:"Sin Gym tarde", check:[]},
                {id: "40", start:"06:00", end:"06:30", cat:"aseo", title:"Ducha", desc:"", check:[]},
                {id: "41", start:"06:30", end:"07:00", cat:"casa", title:"Desayuno/Sala", desc:"Limpieza Sala R√°pida", check:[]},
                {id: "42", start:"07:00", end:"08:30", cat:"traslado", title:"Viaje Chorrillos", desc:"Audio Ingl√©s", check:[]},
                {id: "43", start:"08:30", end:"11:30", cat:"social", title:"Voluntariado", desc:"Alto Per√∫", check:[]},
                {id: "44", start:"11:30", end:"13:00", cat:"traslado", title:"Retorno/Almuerzo", desc:"Comer en ruta", check:[]},
                {id: "45", start:"13:30", end:"17:30", cat:"estudio", title:"Biblioteca", desc:"Foco PUCP", check:[]},
                {id: "46", start:"18:45", end:"22:00", cat:"bomba", title:"Guardia Noche", desc:"", check:[]},
                {id: "47", start:"22:00", end:"22:15", cat:"casa", title:"DESCONEXI√ìN", desc:"", check:[]}
            ]},
            viernes: { title: "Remate", items: [
                {id: "48", start:"05:00", end:"05:15", cat:"aseo", title:"Despertar", desc:"", check:[]},
                {id: "49", start:"05:15", end:"06:00", cat:"fisico", title:"Running", desc:"Fondo", check:[]},
                {id: "50", start:"06:00", end:"06:30", cat:"aseo", title:"Ducha", desc:"", check:[]},
                {id: "51", start:"06:30", end:"07:30", cat:"casa", title:"Chef (Cocina)", desc:"Cocina interdiaria", check:[]},
                {id: "52", start:"07:30", end:"08:00", cat:"casa", title:"Desayuno", desc:"", check:[]},
                {id: "53", start:"08:00", end:"10:00", cat:"estudio", title:"Estudio / Gesti√≥n", desc:"", check:[]},
                {id: "54", start:"10:30", end:"12:00", cat:"estudio", title:"ESTUDIO INTENSIVO PUCP", desc:"Reemplazo Piscina - Mate/Letras", check:[]},
                {id: "55", start:"12:30", end:"13:30", cat:"casa", title:"Almuerzo", desc:"Comida Fija", check:[]},
                {id: "56", start:"14:00", end:"18:00", cat:"estudio", title:"App Farmacia", desc:"Proyecto Novia", check:[]},
                {id: "57", start:"18:15", end:"20:00", cat:"fisico", title:"Gimnasio", desc:"Fuerza Pierna", check:[]},
                {id: "58", start:"20:00", end:"21:00", cat:"casa", title:"Cena", desc:"", check:[]},
                {id: "59", start:"22:00", end:"22:15", cat:"casa", title:"DESCONEXI√ìN", desc:"", check:[]}
            ]},
            sabado: { title: "Pareja", items: [
                {id: "60", start:"06:00", end:"07:00", cat:"casa", title:"Aseo + Desayuno", desc:"R√°pido", check:[]},
                {id: "61", start:"07:00", end:"08:00", cat:"traslado", title:"Salida c/ Mam√°", desc:"Ahorro", check:[]},
                {id: "62", start:"08:00", end:"13:00", cat:"estudio", title:"Estudio Fuera", desc:"Caf√©/Biblio", check:[]},
                {id: "63", start:"13:00", end:"14:00", cat:"casa", title:"Almuerzo", desc:"Calle", check:[]},
                {id: "64", start:"14:00", end:"16:00", cat:"social", title:"Gym Pareja", desc:"Con Novia", check:[]},
                {id: "65", start:"16:30", end:"18:00", cat:"casa", title:"Lavander√≠a 2", desc:"Opcional tarde", check:[]},
                {id: "66", start:"18:00", end:"23:00", cat:"social", title:"Cita Novia", desc:"Calidad", check:[]},
                {id: "68", start:"23:00", end:"23:15", cat:"casa", title:"DESCONEXI√ìN", desc:"Buenas noches", check:[]}
            ]},
            domingo: { title: "Guardia", items: [
                {id: "69", start:"05:30", end:"06:00", cat:"aseo", title:"Despertar + Aseo", desc:"Preparar Uniforme", check:[{text:"Botas", done:false}]},
                {id: "70", start:"06:00", end:"07:00", cat:"traslado", title:"Traslado Bomba", desc:"Llegar antes", check:[]},
                {id: "71", start:"07:00", end:"21:00", cat:"bomba", title:"GUARDIA TOTAL", desc:"14h. Comidas all√≠.", check:[{text:"Llevar libros", done:false}, {text:"Taper Desayuno", done:false}, {text:"Taper Almuerzo", done:false}]},
                {id: "72", start:"21:00", end:"22:00", cat:"traslado", title:"Retorno Casa", desc:"", check:[]},
                {id: "73", start:"22:00", end:"22:15", cat:"casa", title:"DESCONEXI√ìN", desc:"Aseo + Dormir", check:[]}
            ]}
        };
        const dayLabels = { lunes: "Lun", martes: "Mar", miercoles: "Mi√©", jueves: "Jue", viernes: "Vie", sabado: "S√°b", domingo: "Dom" };
        const dayMap = {lunes:0, martes:1, miercoles:2, jueves:3, viernes:4, sabado:5, domingo:6};
        const defaultLoadouts = { estudio: { icon: "fa-book", label: "Mochila PUCP", items: ["Laptop + Cargador", "Cuaderno Notas"] }, gym: { icon: "fa-dumbbell", label: "Gym", items: ["Toalla", "Agua", "Ropa Cambio"] }, bomba: { icon: "fa-fire-extinguisher", label: "Guardia", items: ["Uniforme", "Botas", "DNI", "Linterna"] }, diario: { icon: "fa-sun", label: "Diario", items: ["Llaves", "Billetera", "Celular"] } };
        const medalsDef = { madrugador: { id: "madrugador", title: "Madrugador", desc: "5 d√≠as seguidos 5:00 AM", icon: "fa-sun", req: 5 }, pucp: { id: "pucp", title: "Operador PUCP", desc: "20 hrs estudio", icon: "fa-graduation-cap", req: 1200 }, guardia: { id: "guardia", title: "Guardia de Hierro", desc: "Domingo completo", icon: "fa-shield-alt", req: 1 }, titan: { id: "titan", title: "Tit√°n de Acero", desc: "10 hrs entreno", icon: "fa-dumbbell", req: 600 }, chef: { id: "chef", title: "Log√≠stica", desc: "15 tareas casa", icon: "fa-utensils", req: 15 }, veterano: { id: "veterano", title: "Veterano", desc: "50 misiones", icon: "fa-medal", req: 50 } };

        let appData = { weeks: {}, categories: defaultCats, currentWeekId: "semana-1", currentDayKey: "lunes", goals: [], warehouse: [], customLoadouts: {}, stats: { streak5AM: 0, last5AMDate: null, studyMinutes: 0, guardiaSundays: 0, fisicoMinutes: 0, casaTasks: 0, totalTasks: 0 }, unlockedMedals: [] };
        let activeEvent = null; let activeFilter = 'all'; let deleteConfirmState = false; let touchStartX = 0; let touchEndX = 0; let newGoalType='simple'; let activeGapStart=0;

        // --- 4. FUNCIONES CORE ---
        window.saveData = function() { localStorage.setItem('agenda_2026_v53_full_schedule', JSON.stringify(appData)); }
        
        window.generateFullYear = function() {
            for(let i=1; i<=52; i++) { if(!appData.weeks[`semana-${i}`]) appData.weeks[`semana-${i}`] = JSON.parse(JSON.stringify(templateWeek)); }
            window.saveData();
        }

        window.setCurrentDay = function() {
            const today = new Date(); today.setHours(0,0,0,0);
            const dayIdx = today.getDay();
            appData.currentDayKey = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'][dayIdx];
            const start = new Date(YEAR_START_DATE);
            const diff = today - start;
            const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (diffDays >= 0) {
                 const weekNum = Math.floor(diffDays / 7) + 1;
                 if(weekNum > 0 && weekNum <= 53) appData.currentWeekId = `semana-${weekNum}`;
            }
        }

        window.jumpToCurrentWeek = function() { 
            window.setCurrentDay(); 
            window.render(); 
            document.getElementById('week-menu').classList.add('hidden');
        }

        window.renderWeekMenu = function() { const c = document.getElementById('week-list-container'); if(c) { c.innerHTML = ""; Object.keys(appData.weeks).forEach((k,i) => c.innerHTML += `<button onclick="window.switchWeek('${k}')" class="w-full text-left p-2 border-b text-sm">Semana ${i+1}</button>`); } }
        window.toggleWeekMenu = function() { document.getElementById('week-menu').classList.toggle('hidden'); }
        window.switchWeek = function(k) { appData.currentWeekId = k; window.toggleWeekMenu(); window.render(); }
        window.renderNav = function() { const c = document.getElementById('bottom-nav'); if(c) { c.innerHTML = Object.keys(dayLabels).map(k => `<button onclick="appData.currentDayKey='${k}'; render();" class="flex flex-col items-center min-w-[50px] p-2 rounded-xl ${appData.currentDayKey===k?'bg-slate-900 text-white':'text-slate-400'}"><span class="text-[10px] font-bold uppercase">${dayLabels[k]}</span></button>`).join(''); } }
        
        window.renderCategories = function() {
            const grid = document.getElementById('category-grid'); if(!grid) return; grid.innerHTML = "";
            Object.entries(appData.categories).forEach(([key, val]) => {
                const color = val.color || 'slate';
                const borderColor = `border-${color}-200`; const textColor = `text-${color}-600`; const bgColor = `bg-${color}-50`;
                const iconHTML = val.icon.startsWith('fa-') ? `<i class="fas ${val.icon} text-lg mb-1 opacity-80"></i>` : `<span class="text-lg mb-1 block">${val.icon}</span>`;
                const isDefault = defaultCats[key] !== undefined;
                let btnGroup = '';
                if (!isDefault) { btnGroup = `<div onclick="event.stopPropagation(); window.deleteCategory(event, '${key}')" class="cat-delete-btn"><i class="fas fa-times"></i></div>`; }
                grid.innerHTML += `<div onclick="window.selectCat('${key}')" class="cat-select cursor-pointer p-2 rounded-xl border ${borderColor} ${bgColor} ${textColor} text-center transition hover:opacity-80 active:scale-95" data-val="${key}">${btnGroup}${iconHTML}<span class="block text-[8px] font-bold uppercase truncate">${val.label}</span></div>`;
            });
        }
        
        window.deleteCategory = function(e, key) {
            e.preventDefault(); e.stopPropagation();
            if(confirm(`¬øEliminar categor√≠a "${appData.categories[key].label}"?`)) {
                delete appData.categories[key];
                if(document.getElementById('input-cat').value === key) window.selectCat('general');
                window.saveData(); window.renderCategories();
            }
        }

        window.renderTimeline = function() {
            const items = appData.weeks[appData.currentWeekId][appData.currentDayKey].items;
            items.sort((a,b) => window.timeToMins(a.start) - window.timeToMins(b.start));
            const container = document.getElementById('timeline-container'); if(!container) return;
            container.innerHTML = '<div class="timeline-track"></div>';
            if(items.length === 0) { container.innerHTML += `<div class="text-center p-10 text-slate-400 italic">D√≠a Libre</div>`; return; }

            const today = new Date(); today.setHours(0,0,0,0);
            const weekIdx = parseInt(appData.currentWeekId.split('-')[1]) - 1;
            const viewDate = new Date(YEAR_START_DATE); viewDate.setDate(viewDate.getDate() + (weekIdx * 7) + dayMap[appData.currentDayKey]); viewDate.setHours(0,0,0,0);
            const tTime = today.getTime(); const vTime = viewDate.getTime();
            let dayStatus = 'today'; if (vTime < tTime) dayStatus = 'past'; if (vTime > tTime) dayStatus = 'future';
            const nowMins = window.getNowMins(); let lastEndTime = 0;

            items.forEach((item, index) => {
                const catData = appData.categories[item.cat] || defaultCats.general;
                const iconHTML = catData.icon.startsWith('fa-') ? `<i class="fas ${catData.icon}"></i>` : `<span>${catData.icon}</span>`;
                let colorBase = catData.color || 'slate';
                const colorMap = { green: '#16a34a', blue: '#2563eb', red: '#dc2626', amber: '#d97706', purple: '#9333ea', slate: '#475569', cyan: '#0891b2', pink: '#db2777', indigo: '#4f46e5', teal: '#0d9488', orange: '#ea580c' };
                let bgHex = colorMap[colorBase] || '#475569';
                const startMins = window.timeToMins(item.start);
                
                if (index > 0) {
                    const gap = Math.floor(startMins - lastEndTime);
                    if (gap > 15) container.insertAdjacentHTML('beforeend', `<div class="relative pl-12 mb-3"><div class="gap-card ml-2 mb-2 border-2 border-dashed border-blue-200 p-2 rounded-lg bg-blue-50/50 flex justify-between items-center transition cursor-pointer action-btn" onclick="window.openGapModal(${lastEndTime}, ${gap})"><div><span class="text-[9px] font-bold text-blue-400 uppercase tracking-widest block">‚ö° Tiempo Libre</span><span class="text-xs font-bold text-blue-600">${gap} min</span></div><i class="fas fa-plus text-blue-300"></i></div></div>`);
                }
                
                let itemEndMins = item.end ? window.timeToMins(item.end) : startMins + 60;
                lastEndTime = itemEndMins;

                let progress = 0; let stateClass = "card-future"; let statusBadge = ""; let finishedIconOverlay = "";
                let borderStyle = `border-left-color: ${bgHex};`; let iconBgStyle = ""; let iconColorClass = "text-slate-400"; let fillStyle = "";

                let isPastItem = false; let isFutureItem = false; let isActiveItem = false;

                if (dayStatus === 'past') { isPastItem = true; } else if (dayStatus === 'future') { isFutureItem = true; } else { if (nowMins > itemEndMins) isPastItem = true; else if (nowMins >= startMins) isActiveItem = true; else isFutureItem = true; }

                if (item.completed) {
                    stateClass = "card-completed"; statusBadge = `<span class="text-[9px] font-bold text-green-700 ml-2 flex items-center gap-1"><i class="fas fa-check-circle"></i> Completado</span>`;
                    finishedIconOverlay = `<div class="absolute right-4 top-1/2 -translate-y-1/2 text-green-500 text-4xl opacity-20 pointer-events-none"><i class="fas fa-check"></i></div>`;
                    iconColorClass = `text-green-600`; iconBgStyle = `background-color: #dcfce7;`;
                } else if (isPastItem) {
                    stateClass = "card-past"; progress = 100; statusBadge = `<span class="text-[9px] font-bold text-slate-400 ml-2">Finalizado</span>`;
                    finishedIconOverlay = `<div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 text-4xl opacity-20 pointer-events-none"><i class="fas fa-check"></i></div>`;
                    borderStyle += `border-color: ${bgHex}60;`; iconColorClass = `text-${colorBase}-600`; iconBgStyle = `background-color: ${bgHex}20;`; fillStyle = `width: 100%; background-color: ${bgHex}; opacity: 0.6;`; 
                    if (dayStatus === 'today' && !item.completedNotified && !item.skipped) { item.completedNotified = true; window.saveData(); window.showCompletionModal(item.title); }
                } else if (isActiveItem) {
                    stateClass = "card-active"; const totalDuration = itemEndMins - startMins; if (totalDuration > 0) progress = ((nowMins - startMins) / totalDuration) * 100;
                    statusBadge = `<span class="text-[9px] font-bold text-white px-2 py-0.5 rounded-full ml-2" style="background-color: ${bgHex}">En curso</span>`;
                    borderStyle += `border-color: ${bgHex};`; iconColorClass = `text-${colorBase}-700`; iconBgStyle = `background-color: ${bgHex}30;`; fillStyle = `width: ${progress}%; background-color: ${bgHex}; opacity: 0.8;`;
                } else { iconColorClass = `text-${colorBase}-500`; iconBgStyle = `background-color: ${bgHex}10;`; fillStyle = `width: 0%;`; }
                if(item.skipped) { stateClass = "card-past skipped-card"; statusBadge = `<span class="text-[9px] text-slate-400 ml-2">Saltado</span>`; fillStyle = `width: 100%; background-color: #cbd5e1; opacity: 0.1;`; }

                const html = `<div class="relative pl-16 mb-4 event-card group ${stateClass}" id="card-${item.id}" onclick="window.openModal('${item.id}')" style="${borderStyle}">
                    <div class="absolute left-0 top-0 w-12 text-right pt-4 z-10"><div class="text-xs font-bold text-slate-900 font-mono">${item.start}</div><div class="text-[10px] text-slate-400 font-medium">${item.end || '...'}</div></div>
                    <div class="absolute left-[3.5rem] top-6 w-2 h-2 rounded-full bg-white border-2 border-slate-300 z-10 shadow-sm" style="${isActiveItem ? `border-color: ${bgHex}; background: ${bgHex};` : ''}"></div>
                    <div class="ml-2 bg-white rounded-3xl overflow-hidden relative"><div class="card-progress-fill" style="${fillStyle}"></div>${finishedIconOverlay}<div class="p-5 flex justify-between items-start relative z-10"><div><div class="flex items-center gap-1 mb-1 flex-wrap"><span class="text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full bg-white/80 border shadow-sm backdrop-blur-sm" style="color: ${bgHex}; border-color: ${bgHex}40;">${catData.label}</span>${statusBadge}</div><h3 class="font-bold text-sm text-slate-800 leading-tight ${item.skipped ? 'skipped-text' : ''}">${item.title}</h3><p class="text-xs text-slate-500 mt-1 truncate w-40">${item.desc || ''}</p></div><div class="w-8 h-8 rounded-full flex items-center justify-center shadow-sm backdrop-blur-sm card-icon-bg ${iconColorClass}" style="${iconBgStyle}">${iconHTML}</div></div></div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        window.updateHeader = function() { 
            const elTitle = document.getElementById('day-display-title'); 
            if(elTitle) elTitle.innerText = appData.currentDayKey; 
            const weekIdx = parseInt(appData.currentWeekId.split('-')[1]) - 1; 
            const d = new Date(YEAR_START_DATE); 
            d.setDate(d.getDate() + (weekIdx * 7) + dayMap[appData.currentDayKey]); 
            const fullDate = d.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'});
            const elSubtitle = document.getElementById('day-display-subtitle'); 
            if(elSubtitle) elSubtitle.innerText = fullDate.charAt(0).toUpperCase() + fullDate.slice(1);
            const elDate = document.getElementById('date-display'); 
            if(elDate) elDate.innerText = d.toLocaleDateString('es-ES', {day:'numeric', month:'short'});
            const elWkLabel = document.getElementById('current-week-label'); 
            if(elWkLabel) elWkLabel.innerText = `Semana ${weekIdx+1}`; 
            const startWk = new Date(YEAR_START_DATE); startWk.setDate(startWk.getDate() + (weekIdx * 7)); 
            const endWk = new Date(startWk); endWk.setDate(endWk.getDate() + 6); 
            const elWkDate = document.getElementById('current-week-date'); 
            if(elWkDate) elWkDate.innerText = `${startWk.toLocaleDateString('es-ES',{day:'numeric', month:'short'})} - ${endWk.toLocaleDateString('es-ES',{day:'numeric', month:'short'})}`; 
            const currentMins = window.getNowMins(); 
            const elProgress = document.getElementById('day-progress'); 
            const pct = Math.max(0, Math.min(100, ((currentMins - 300) / (18*60)) * 100)); 
            if(elProgress) elProgress.style.width = `${pct}%`; 
        }

        window.render = function() { 
            window.renderWeekMenu(); 
            window.renderNav(); 
            window.renderCategories(); 
            window.renderTimeline(); 
            window.updateHeader(); 
        }

        // --- 6. LOGICA Y UI ---
        window.openModal = function(id) {
            const items = appData.weeks[appData.currentWeekId][appData.currentDayKey].items; activeEvent = items.find(i => String(i.id) === String(id)); if(!activeEvent) return;
            deleteConfirmState = false; const btn = document.getElementById('btn-delete-event'); if(btn) { btn.innerHTML = "BORRAR"; btn.classList.remove('btn-confirm-delete'); }
            document.getElementById('modal-title').innerText = activeEvent.title; const endTxt = activeEvent.end ? activeEvent.end : "En Progreso"; document.getElementById('modal-time-range').innerText = `${activeEvent.start} - ${endTxt}`;
            window.renderChecklist(); window.renderLoadoutCarousel();
            document.getElementById('view-mode-content').classList.remove('hidden'); document.getElementById('gap-mode-content').classList.add('hidden'); document.getElementById('event-form').classList.add('hidden');
            const now = window.getNowMins(); const start = window.timeToMins(activeEvent.start); const end = activeEvent.end ? window.timeToMins(activeEvent.end) : start + 60; const expiration = end + 60;
            const today = new Date(); today.setHours(0,0,0,0); const weekIdx = parseInt(appData.currentWeekId.split('-')[1]) - 1; const viewDate = new Date(YEAR_START_DATE); viewDate.setDate(viewDate.getDate() + (weekIdx * 7) + dayMap[appData.currentDayKey]); viewDate.setHours(0,0,0,0);
            const isToday = (today.getTime() === viewDate.getTime());
            let btnHtml = '';
            if (activeEvent.completed) { btnHtml = `<button class="w-full py-4 bg-green-100 text-green-700 font-bold rounded-2xl shadow-none cursor-default border border-green-200 flex items-center justify-center gap-2"><i class="fas fa-check-circle text-xl"></i> YA COMPLETADO</button>`; } 
            else if (!isToday) { btnHtml = `<button disabled class="w-full py-4 bg-slate-100 text-slate-400 font-bold rounded-2xl cursor-not-allowed">SOLO DISPONIBLE EL D√çA</button>`; }
            else if (now < start) { btnHtml = `<button disabled class="w-full py-4 bg-slate-200 text-slate-400 font-bold rounded-2xl cursor-not-allowed flex items-center justify-center gap-2"><i class="fas fa-hourglass-start"></i> ESPERA INICIO ${activeEvent.start}</button>`; } 
            else if (now > expiration) { btnHtml = `<button disabled class="w-full py-4 bg-red-50 text-red-400 font-bold rounded-2xl cursor-not-allowed border border-red-100 flex items-center justify-center gap-2"><i class="fas fa-lock"></i> TIEMPO AGOTADO</button>`; } 
            else { btnHtml = `<button onclick="window.completeMission()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-2xl shadow-lg shadow-green-200 hover:shadow-xl hover:scale-[1.02] transition flex items-center justify-center gap-2 animate-pulse"><i class="fas fa-flag"></i> ¬°MISI√ìN CUMPLIDA!</button>`; }
            document.getElementById('mission-control-container').innerHTML = btnHtml;
            const card = document.getElementById('modal-card'); document.getElementById('modal-overlay').classList.remove('hidden'); setTimeout(() => card.classList.add('active'), 10);
        }

        window.renderLoadoutCarousel = function() {
            const container = document.getElementById('loadout-carousel'); if(!container) return; container.innerHTML = "";
            const allLoadouts = { ...defaultLoadouts, ...(appData.customLoadouts || {}) };
            Object.entries(allLoadouts).forEach(([key, val]) => {
                container.innerHTML += `<button onclick="window.applyLoadout('${key}')" class="flex-shrink-0 w-16 h-20 bg-white border border-indigo-100 rounded-xl flex flex-col items-center justify-center gap-1 shadow-sm active:scale-95 transition group relative overflow-hidden"><div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center text-sm group-hover:bg-indigo-500 group-hover:text-white transition"><i class="fas ${val.icon}"></i></div><span class="text-[9px] font-bold text-slate-500 uppercase tracking-tight truncate w-full text-center px-1">${val.label}</span></button>`;
            });
            container.innerHTML += `<button onclick="window.saveCurrentAsLoadout()" class="flex-shrink-0 w-16 h-20 bg-indigo-50/50 border border-dashed border-indigo-300 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition hover:bg-indigo-100"><div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-400 flex items-center justify-center"><i class="fas fa-plus"></i></div><span class="text-[9px] font-bold text-indigo-400 uppercase">Crear Kit</span></button>`;
        }
        
        window.saveCurrentAsLoadout = function() {
            if (!activeEvent || !activeEvent.check || activeEvent.check.length === 0) { alert("A√±ade items primero."); return; }
            const name = prompt("Nombre del Kit:"); if (!name) return;
            const id = "custom_" + Date.now();
            appData.customLoadouts[id] = { label: name, icon: "fa-box", items: activeEvent.check.map(t => t.text) };
            window.saveData(); window.renderLoadoutCarousel(); 
        }
        
        window.applyLoadout = function(key) {
            if (!activeEvent) return;
            const allLoadouts = { ...defaultLoadouts, ...(appData.customLoadouts || {}) };
            const loadout = allLoadouts[key]; if (!loadout) return;
            if(!activeEvent.check) activeEvent.check = [];
            const currentTexts = activeEvent.check.map(t => t.text);
            loadout.items.forEach(item => { if(!currentTexts.includes(item)) activeEvent.check.push({ text: item, done: false }); });
            window.saveData(); window.renderChecklist();
        }

        // --- FUNCIONES AUXILIARES RESTANTES ---
        window.closeModal = function() { document.getElementById('modal-card').classList.remove('active'); setTimeout(() => { document.getElementById('modal-overlay').classList.add('hidden'); activeEvent = null; }, 300); }
        window.openGapModal = function(startMins, duration) { activeGapStart = startMins; document.getElementById('gap-duration').innerText = `${duration} min`; document.getElementById('view-mode-content').classList.add('hidden'); document.getElementById('event-form').classList.add('hidden'); document.getElementById('gap-mode-content').classList.remove('hidden'); const grid = document.getElementById('gap-suggestions-grid'); grid.innerHTML = ""; const options = [{title: "Flashcards", cat: "estudio", icon: "fa-bolt", desc: "Repaso veloz"}, {title: "Orden R√°pido", cat: "casa", icon: "fa-broom", desc: "Despeja mente"}, {title: "Skincare", cat: "aseo", icon: "fa-spray-can", desc: "Refrescarse"}, {title: "Traslado", cat: "traslado", icon: "fa-bus", desc: "Moverse a punto B"}, {title: "Lectura", cat: "estudio", icon: "fa-book-open", desc: "Avance suave"}, {title: "Estoy Agotado", cat: "casa", icon: "fa-face-tired", desc: "Recarga pasiva üòû"}]; options.forEach(opt => { grid.innerHTML += `<button onclick="window.fillGap('${opt.title}', '${opt.cat}')" class="suggestion-card p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:border-blue-300 hover:bg-blue-50 transition text-left flex items-center gap-4 group w-full"><div class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center group-hover:scale-110 transition"><i class="fas ${opt.icon}"></i></div><div><div class="font-bold text-slate-700 text-sm">${opt.title}</div><div class="text-xs text-slate-400">${opt.desc}</div></div></button>`; }); document.getElementById('modal-title').innerText = "Oportunidad"; document.getElementById('modal-time-range').innerText = `Inicio: ${window.minsToTime(startMins)}`; document.getElementById('modal-card'); document.getElementById('modal-overlay').classList.remove('hidden'); setTimeout(() => document.getElementById('modal-card').classList.add('active'), 10); }
        window.fillGap = function(title, cat) { const newItem = { id: Date.now().toString(), title: title, start: window.minsToTime(activeGapStart), end: null, cat: cat, desc: "Tiempo aprovechado", check: [], skipped: false }; let items = appData.weeks[appData.currentWeekId][appData.currentDayKey].items; items.push(newItem); appData.weeks[appData.currentWeekId][appData.currentDayKey].items = items; window.saveData(); window.renderTimeline(); window.closeModal(); }
        window.deleteEvent = function(btnElement) { if(!activeEvent) return; if (!deleteConfirmState) { deleteConfirmState = true; btnElement.innerHTML = "¬øCONFIRMAR?"; btnElement.classList.add('btn-confirm-delete'); } else { const k = appData.currentDayKey; const wk = appData.currentWeekId; appData.weeks[wk][k].items = appData.weeks[wk][k].items.filter(i => String(i.id) !== String(activeEvent.id)); window.saveData(); window.renderTimeline(); window.closeModal(); } }
        window.skipEvent = function() { if(!activeEvent) return; activeEvent.skipped = !activeEvent.skipped; window.saveData(); window.renderTimeline(); window.closeModal(); }
        window.finishEventNow = function() { if(!activeEvent) return; const now = new Date(); activeEvent.end = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; window.saveData(); window.renderTimeline(); window.closeModal(); }
        window.enableEditMode = function() { document.getElementById('view-mode-content').classList.add('hidden'); document.getElementById('event-form').classList.remove('hidden'); document.getElementById('input-title').value = activeEvent.title; document.getElementById('input-start').value = activeEvent.start; document.getElementById('input-end').value = activeEvent.end||""; document.getElementById('event-id').value = activeEvent.id; window.selectCat(activeEvent.cat); }
        window.renderChecklist = function() { const list = document.getElementById('checklist-container'); list.innerHTML = ""; (activeEvent.check || []).forEach((task, idx) => { list.innerHTML += `<li class="flex items-center justify-between p-3 bg-slate-50 rounded-xl mb-2 group"><div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="window.toggleCheck(${idx})"><div class="w-5 h-5 rounded border ${task.done ? 'bg-green-500 border-green-500' : 'border-slate-300 bg-white'} flex items-center justify-center transition-colors">${task.done ? '<i class="fas fa-check text-white text-[10px]"></i>' : ''}</div><span class="text-sm ${task.done ? 'line-through text-slate-400' : 'text-slate-700'}">${task.text}</span></div><div class="flex gap-1 checklist-item-actions"><button onclick="window.removeCheckItem(${idx})" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:text-red-500 hover:bg-red-50 transition action-btn"><i class="fas fa-trash-alt text-xs"></i></button></div></li>`; }); }
        window.toggleCheck = function(idx) { activeEvent.check[idx].done = !activeEvent.check[idx].done; window.saveData(); window.renderChecklist(); }
        window.removeCheckItem = function(idx) { activeEvent.check.splice(idx, 1); window.saveData(); window.renderChecklist(); }
        window.addCheckItem = function() { const v = document.getElementById('new-check-item').value; if(v) { if(!activeEvent.check) activeEvent.check=[]; activeEvent.check.push({text:v, done:false}); document.getElementById('new-check-item').value=""; window.saveData(); window.renderChecklist(); } }
        window.openAddModal = function() { activeEvent=null; document.getElementById('view-mode-content').classList.add('hidden'); document.getElementById('gap-mode-content').classList.add('hidden'); document.getElementById('event-form').classList.remove('hidden'); document.getElementById('event-form').reset(); window.renderCategories(); document.getElementById('input-cat').value='general'; document.getElementById('modal-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('modal-card').classList.add('active'),10); }
        window.toggleNewCatUI = function() { const g = document.getElementById('input-add-cat-group'); const b = document.getElementById('btn-add-cat'); if(g.classList.contains('hidden')) { g.classList.remove('hidden'); b.classList.add('hidden'); } else { g.classList.add('hidden'); b.classList.remove('hidden'); } }
        window.saveNewCategory = function() { const n = document.getElementById('input-new-cat-name').value; if(n) { const id = "c"+Date.now(); appData.categories[id] = {label:n, color:'indigo', icon:document.getElementById('input-new-cat-emoji').value||"‚ö°"}; window.saveData(); window.renderCategories(); window.selectCat(id); window.toggleNewCatUI(); } }
        window.openGoalsModal = function() { document.getElementById('goals-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('goals-card').classList.add('active'),10); window.renderGoals(); }
        window.closeGoalsModal = function() { document.getElementById('goals-card').classList.remove('active'); setTimeout(()=>document.getElementById('goals-card').parentElement.classList.add('hidden'),300); }
        window.renderGoals = function() { const c = document.getElementById('goals-list-container'); c.innerHTML = ""; appData.goals.forEach(goal => { let h = ""; if(goal.type==='savings'){ const p = Math.min(100, Math.round((goal.current/goal.target)*100)); h=`<div class="goal-card bg-white p-4 rounded-xl shadow-sm"><div class="flex justify-between mb-2"><h4 class="font-bold text-sm">${goal.title}</h4><button onclick="window.deleteGoal(this,'${goal.id}')" class="text-slate-300"><i class="fas fa-trash-alt"></i></button></div><div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden relative"><div class="bg-green-500 h-full" style="width:${p}%"></div><span class="absolute inset-0 text-[9px] flex items-center justify-center font-bold text-slate-600">${p}%</span></div><div class="flex justify-between items-center mt-2"><span class="text-xs font-mono text-slate-500">S/ ${goal.current} / ${goal.target}</span><button onclick="window.updateSavings('${goal.id}')" class="w-8 h-8 bg-green-100 text-green-700 rounded-full font-bold flex items-center justify-center">+</button></div></div>`; } else { h=`<div class="goal-card ${goal.done?'done bg-slate-50':''} p-4 rounded-xl shadow-sm flex justify-between items-start"><div class="flex gap-3 items-center"><div class="w-6 h-6 rounded-full border-2 ${goal.done?'bg-yellow-500 border-yellow-500':'border-slate-300'} flex items-center justify-center cursor-pointer" onclick="window.toggleGoal('${goal.id}')">${goal.done?'<i class="fas fa-check text-white text-xs"></i>':''}</div><h4 class="font-bold text-sm">${goal.title}</h4></div><button onclick="window.deleteGoal(this,'${goal.id}')" class="text-slate-300"><i class="fas fa-trash-alt"></i></button></div>`; } c.insertAdjacentHTML('beforeend', h); }); }
        window.addNewGoal = function() { const t = document.getElementById('new-goal-title').value; if(!t)return; const g={id:Date.now().toString(), title:t, type:newGoalType, done:false}; if(newGoalType==='savings'){g.target=parseFloat(document.getElementById('new-goal-target').value)||0; g.current=parseFloat(document.getElementById('new-goal-current').value)||0;} appData.goals.push(g); window.saveData(); window.renderGoals(); document.getElementById('new-goal-title').value=""; }
        window.deleteGoal = function(b,id) { if(b.classList.contains('text-red-600')){appData.goals=appData.goals.filter(g=>String(g.id)!==String(id)); window.saveData(); window.renderGoals();}else{b.classList.add('text-red-600'); b.innerHTML='Confirmar';} }
        window.toggleGoal = function(id) { const g = appData.goals.find(g=>String(g.id)===String(id)); if(g){g.done=!g.done; window.saveData(); window.renderGoals();} }
        window.updateSavings = function(id) { const a = parseFloat(prompt("Monto:")); const g = appData.goals.find(x=>String(x.id)===String(id)); if(g && !isNaN(a)){g.current+=a; window.saveData(); window.renderGoals();} }
        window.toggleGoalType = function(t) { newGoalType=t; document.getElementById('savings-inputs').classList.toggle('hidden', t!=='savings'); }
        
        window.openWarehouseModal = function() { document.getElementById('warehouse-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('warehouse-card').classList.add('active'),10); window.renderWarehouse(); }
        window.closeWarehouseModal = function() { document.getElementById('warehouse-card').classList.remove('active'); setTimeout(()=>document.getElementById('warehouse-card').parentElement.classList.add('hidden'),300); }
        window.addToWarehouse = function() { const v=document.getElementById('warehouse-input').value.trim(); if(v){ appData.warehouse.push({id:Date.now().toString(), text:v, cat:document.getElementById('warehouse-cat-select').value, date:new Date().toLocaleDateString('es-ES')}); document.getElementById('warehouse-input').value=""; window.saveData(); window.renderWarehouse(); } }
        window.renderWarehouse = function() { const l = document.getElementById('warehouse-list'); l.innerHTML=""; let i = appData.warehouse; if(activeFilter!=='all') i=i.filter(x=>x.cat===activeFilter); i.slice().reverse().forEach(x=>{ l.insertAdjacentHTML('beforeend', `<div class="warehouse-card bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center">üì¶</div><div class="flex-1"><p class="text-sm font-medium">${x.text}</p><span class="text-[10px] text-slate-400">${x.cat}</span></div><button onclick="window.planWarehouseItem('${x.id}')" class="w-8 h-8 bg-slate-50 rounded-full text-indigo-500"><i class="fas fa-plus"></i></button></div>`); }); }
        window.filterWarehouse = function(f) { activeFilter=f; window.renderWarehouse(); }
        window.planWarehouseItem = function(id) { const i = appData.warehouse.find(x=>String(x.id)===String(id)); if(i){ window.closeWarehouseModal(); setTimeout(()=>{ window.openAddModal(); document.getElementById('input-title').value=i.text; document.getElementById('warehouse-origin-id').value=id; },350); } }

        window.completeMission = function() {
            if (!activeEvent) return;
            activeEvent.completed = true;
            const duration = (activeEvent.end ? window.timeToMins(activeEvent.end) : window.timeToMins(activeEvent.start)+60) - window.timeToMins(activeEvent.start);
            appData.stats.totalTasks++;
            if(activeEvent.cat === 'estudio') appData.stats.studyMinutes += duration;
            if(activeEvent.cat === 'fisico') appData.stats.fisicoMinutes += duration;
            if(activeEvent.cat === 'casa') appData.stats.casaTasks++;
            if(activeEvent.start === "05:00") {
                const todayStr = new Date().toDateString();
                if(appData.stats.last5AMDate !== todayStr) { appData.stats.streak5AM++; appData.stats.last5AMDate = todayStr; }
            }
            if(appData.currentDayKey === 'domingo' && activeEvent.cat === 'bomba') {
                const sundayItems = appData.weeks[appData.currentWeekId]['domingo'].items.filter(i => i.cat === 'bomba');
                if(sundayItems.every(i => i.completed)) appData.stats.guardiaSundays++;
            }
            window.saveData();
            window.checkMedals(); 
            window.showCompletionModal(activeEvent.title);
            window.renderTimeline();
            window.openModal(activeEvent.id);
        }
        
        window.checkMedals = function() {
            let newUnlock = false;
            if(appData.stats.streak5AM >= medalsDef.madrugador.req && !appData.unlockedMedals.includes('madrugador')) { appData.unlockedMedals.push('madrugador'); newUnlock = "Madrugador"; }
            if(appData.stats.studyMinutes >= medalsDef.pucp.req && !appData.unlockedMedals.includes('pucp')) { appData.unlockedMedals.push('pucp'); newUnlock = "Operador PUCP"; }
            if(appData.stats.guardiaSundays >= medalsDef.guardia.req && !appData.unlockedMedals.includes('guardia')) { appData.unlockedMedals.push('guardia'); newUnlock = "Guardia de Hierro"; }
            if(appData.stats.fisicoMinutes >= medalsDef.titan.req && !appData.unlockedMedals.includes('titan')) { appData.unlockedMedals.push('titan'); newUnlock = "Tit√°n de Acero"; }
            if(appData.stats.casaTasks >= medalsDef.chef.req && !appData.unlockedMedals.includes('chef')) { appData.unlockedMedals.push('chef'); newUnlock = "Log√≠stica Dom√©stica"; }
            if(appData.stats.totalTasks >= medalsDef.veterano.req && !appData.unlockedMedals.includes('veterano')) { appData.unlockedMedals.push('veterano'); newUnlock = "Veterano de Guerra"; }
            if(newUnlock) { window.saveData(); alert(`üèÖ ¬°NUEVA MEDALLA DESBLOQUEADA!\n\n${newUnlock}`); window.playSuccessSound(); }
        }

        window.openMedalsModal = function() {
            const container = document.getElementById('medals-grid'); container.innerHTML = "";
            Object.values(medalsDef).forEach(m => {
                const isUnlocked = appData.unlockedMedals.includes(m.id);
                let progressTxt = "";
                if(m.id === 'madrugador') progressTxt = `${appData.stats.streak5AM}/${m.req} d√≠as`;
                if(m.id === 'pucp') progressTxt = `${Math.floor(appData.stats.studyMinutes/60)}/${Math.floor(m.req/60)} hrs`;
                if(m.id === 'guardia') progressTxt = `${appData.stats.guardiaSundays}/${m.req}`;
                if(m.id === 'titan') progressTxt = `${Math.floor(appData.stats.fisicoMinutes/60)}/${Math.floor(m.req/60)} hrs`;
                if(m.id === 'chef') progressTxt = `${appData.stats.casaTasks}/${m.req} mixs`;
                if(m.id === 'veterano') progressTxt = `${appData.stats.totalTasks}/${m.req} ops`;
                container.innerHTML += `<div class="p-4 rounded-2xl flex items-center gap-4 ${isUnlocked?"medal-unlocked border-2 border-yellow-400 bg-yellow-50":"medal-locked bg-slate-50 border"}"><div class="w-12 h-12 rounded-full bg-white flex items-center justify-center shadow-sm text-2xl ${isUnlocked?"text-yellow-500":"text-slate-300"}"><i class="fas ${m.icon}"></i></div><div><h4 class="font-bold text-sm text-slate-800">${m.title}</h4><p class="text-xs text-slate-500">${m.desc}</p><div class="text-[10px] font-bold text-slate-400 mt-1 uppercase">${progressTxt}</div></div></div>`;
            });
            document.getElementById('medals-card').parentElement.classList.remove('hidden'); setTimeout(()=>document.getElementById('medals-card').classList.add('active'),10);
        }
        window.closeMedalsModal = function() { document.getElementById('medals-card').classList.remove('active'); setTimeout(()=>document.getElementById('medals-card').parentElement.classList.add('hidden'),300); }
        window.generateDailyBriefing = async function() { const c = document.getElementById('ai-briefing-container'); const t = document.getElementById('ai-briefing-text'); c.classList.remove('hidden'); t.innerHTML = "Analizando..."; setTimeout(() => { t.innerHTML = `<strong>${appData.currentDayKey.toUpperCase()}:</strong> Mant√©n el foco.`; }, 800); }
        window.setupEventListeners = function() { document.getElementById('event-form').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('event-id').value; const newEvt = { id: id ? id : Date.now().toString(), title: document.getElementById('input-title').value, start: document.getElementById('input-start').value, end: document.getElementById('input-end').value || null, cat: document.getElementById('input-cat').value, desc: "Manual", check: activeEvent ? activeEvent.check : [], skipped: false }; let items = appData.weeks[appData.currentWeekId][appData.currentDayKey].items; if(id) items = items.filter(i => String(i.id) !== String(id)); items.push(newEvt); appData.weeks[appData.currentWeekId][appData.currentDayKey].items = items; window.saveData(); window.renderTimeline(); window.closeModal(); }); }
        window.setupSwipe = function() { const el = document.getElementById('main-scroll'); el.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive:true}); el.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; if(touchEndX < touchStartX - 50) { /* Next day logic if needed */ } else if(touchEndX > touchStartX + 50) { /* Prev day logic */ } }, {passive:true}); }
        window.init = function() {
            const saved = localStorage.getItem('agenda_2026_v53_full_schedule');
            if(saved) {
                try {
                    appData = JSON.parse(saved);
                    if (!appData.categories) appData.categories = defaultCats;
                    else appData.categories = { ...defaultCats, ...appData.categories };
                    if (!appData.customLoadouts) appData.customLoadouts = {};
                    if (!appData.stats) appData.stats = { streak5AM: 0, last5AMDate: null, studyMinutes: 0, guardiaSundays: 0, fisicoMinutes: 0, casaTasks: 0, totalTasks: 0 };
                    if (!appData.unlockedMedals) appData.unlockedMedals = [];
                } catch(e) { window.generateFullYear(); }
            } else {
                window.generateFullYear();
            }
            window.setCurrentDay();
            window.render(); 
            window.setupEventListeners();
            window.setupSwipe();
            window.updateNotifyButton(); 
            
            setInterval(window.updateHeader, 60000);
            setInterval(window.renderTimeline, 2000); 
            setInterval(window.checkAlarms, 30000);
        }

        window.init(); // EJECUCI√ìN FINAL
    </script>
</body>
</html>

